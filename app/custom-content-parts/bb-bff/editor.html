<script
	src="https://cdnjs.cloudflare.com/ajax/libs/multi-select/0.9.12/js/jquery.multi-select.min.js"
	type="text/javascript"></script>
<script type="text/javascript"
	src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.12.0/jquery.validate.min.js"></script>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/multi-select/0.9.12/css/multi-select.min.css"
	/>
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
	/>
<link rel="stylesheet" href="/client/styles/Admin/GenericUI.css" type="text/css"
	/>
<link rel="stylesheet"
	href="https://foundation.uc.edu/file/css/custom-content-part-styles.css"
	type="text/css" />

<style>
	.Staff {
		display: flex !important;
		width: 100%;
		justify-content: space-between !important;
	}
	.Staff > label {
		width: 20% !important;
	}
</style>

<div id="BBTabs">
	<ul>
		<li><a href="#tab-1">Content</a></li>
		<!-- <li><a href="#tab-2">Settings</a></li>
		<li><a href="#tab-3">Question Matrix</a></li> -->
	</ul>

	<!-- FIELDS -->
	<div id="tab-1" class="StepGrouping">
		<h1 class="StepGroupingHeading">
			Page Content
		</h1>
		<div class="StepGroupingBody">
			<div class="HelpText">
				Add, update, remove, and re-order your page content.
			</div>

			<div class="VerticalOption">
				<div class="ItemContainer">
					<div class="ItemTable" cellspacing="0" cellpadding="0">
						<div class="ItemRow" id="ItemRowTemplate">
							<input type="hidden" id="ItemIndex_0" name="ItemIndex_0" />

							<div class="Center">
								<div class="ItemHeader">
									<div class="Counter">
										<span>0</span>
									</div>
									<div class="FieldType"></div>

									<div class="ItemActions" id="DivItemActions_0">
										<a class="ItemActionMove">
											<i class="fa fa-arrows-v"></i>
										</a>
										<a class="ItemActionDelete">
											<i class="fa fa-trash"></i>
										</a>
									</div>
								</div>

								<div class="top">
									<div class="Staff" id="DivStaffQuestion_0">
										<label class="staffName">
											Staff Name:
											<input class="form-control required" type="text" name="StaffName_0"
												id="StaffName_0" />
										</label>
										<label class="staffPosition">
											Staff Position:
											<input class="form-control" type="text"
												name="StaffPosition_0"
												id="StaffPosition_0" />
										</label>
										<label class="staffPhone">
											Staff Phone #:
											<input class="form-control" type="text"
												name="StaffPhoneNumber_0"
												id="StaffPhoneNumber_0" />
										</label>
										<label class="staffEmail">
											Staff Email:
											<input class="form-control" type="text" name="StaffEmail_0"
												id="StaffEmail_0" />
										</label>
									</div>
									<div class="Question" id="DivQuestion_0">
										<label>
											Content:
											<input class="form-control required" type="text" name="Question_0"
												id="Question_0" />
										</label>
									</div>
									<div class="Card" id="DivCard_0">
										<label>
											Content:
											<input class="form-control required" name="Card_0" id="Card_0" />
										</label>
									</div>
									<div class="TextEditor" id="DivTextEditor_0">
										<label>
											Content:
											<textarea class="form-control required tinymce" name="TextEditor_0"
												id="TextEditor_0"></textarea>
										</label>
									</div>
									<div class="MaxLength" id="DivMaxLength_0">
										<label>
											Max length:
											<input class="form-control" type="number" step="1" value="255"
												name="MaxLength_0" id="MaxLength_0" />
										</label>
										<span class="helper">
											Limited to 255
										</span>
									</div>
									<div class="CodeTable" id="DivCodeTable_0">
										<label>
											Code Table ID:
											<input class="form-control required" type="text" name="CodeTable_0"
												id="CodeTable_0" />
										</label>
										<span class="helper">
											GUID of the code table
										</span>
									</div>
									<div class="CodeTableMulti" id="DivCodeTableMulti_0">
										<label>
											Allow Multiple:
											<input class="form-control" type="checkbox" name="CodeTableMulti_0"
												id="CodeTableMulti_0" />
										</label>
										<span class="helper">
											Disables attribute link
										</span>
									</div>
									<div class="Country" id="DivCountry_0">
										<label>
											Country ID:
											<input class="form-control" type="text" name="Country_0"
												id="Country_0" />
										</label>
										<span class="helper">
											GUID of the Country
										</span>
									</div>
								</div>

								<div class="middle">
									<div class="Help" id="DivHelp_0">
										<label>
											Help Text:
											<input class="form-control" type="text" name="Help_0" id="Help_0" />
										</label>
									</div>
									<div class="ColumnWidth" id="DivColumnWidth_0">
										<label>
											Columns(/12):
											<select class="form-control" name="ColumnWidth_0" id="ColumnWidth_0">
												<option>1</option>
												<option>2</option>
												<option>3</option>
												<option>4</option>
												<option>5</option>
												<option>6</option>
												<option>7</option>
												<option>8</option>
												<option>9</option>
												<option>10</option>
												<option>11</option>
												<option selected="selected">
													12
												</option>
											</select>
										</label>
									</div>
								</div>

								<div class="Col3">
									<div class="QuestionRequired" id="DivQuestionRequired_0">
										<label>
											<input class="form-control" type="checkbox" name="QuestionRequired_0"
												id="QuestionRequired_0" />
											Mark as required
										</label>
									</div>

									<div class="LinkAttribute" id="DivLinkAttribute_0">
										<label>
											<input class="form-control" type="checkbox" name="LinkAttribute_0"
												id="LinkAttribute_0" />
											Link to attribute
										</label>

										<div class="LinkAttributeExpand" style="display: none;">
											<label>
												Attribute label:
												<input class="form-control required" type="text" name="Attribute_0"
													id="Attribute_0" />
											</label>
											<br />
											<span class="helper">
												Must match exactly what has been
												set up on the Interaction Add
												form
											</span>
										</div>
									</div>

									<div class="DisplayCondition" id="DivDisplayCondition_0">
										<label>
											<input class="form-control" type="checkbox" name="DisplayCondition_0"
												id="DisplayCondition_0" />
											Display conditionally
										</label>
										<div class="DisplayconditionExpand" style="display: none;">
											<span>Where</span>
											<select name="ddDisplayConditionCompare_0"
												id="ddDisplayConditionCompare_0">
												<option>
													&lt;Select a question&gt;
												</option>
												<option>
													This will be populated
												</option>
												<option>
													With a list of questions
												</option>
											</select>
											<span>is</span>
											<select name="ddDisplayConditionIs_0" id="ddDisplayConditionIs_0">
												<option value="equals">
													Equal To
												</option>
												<option value="not">
													Not Equal To
												</option>
											</select>
											<div class="FieldCompare">
												<input class="required" type="text"
													name="ddDisplayConditionValText_0"
													id="ddDisplayConditionValText_0" />
												<input type="checkbox" name="ddDisplayConditionIsCheckbox_0"
													id="ddDisplayConditionIsCheckbox_0" />
												<select class="required" id="ddDisplayConditionCodeTable_0"
													name="ddDisplayConditionCodeTable_0"></select>
												<select class="required" id="ddDisplayConditionEventCategory_0"
													name="ddDisplayConditionEventCategory_0"></select>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<a class="ItemActionAdd" class="BBAdminButtonLnk" href="#">
					<span class="BBAdminButtonContent">
						<span ass="BBAdminButtonLabel">
							<i class="fa fa-plus-circle"></i>
							Add Content
						</span>
					</span>
				</a>
			</div>
		</div>
	</div>
</div>

<div id="newItem" title="Add a new question">
	<label>
		Field type:
		<br />
		<select id="NewItemFieldType">
			<option value="staff">Staff</option>
			<option value="heading1">Heading 1</option>
			<option value="heading2">Heading 2</option>
			<option value="heading3">Heading 3</option>
			<option value="heading4">Heading 4</option>
			<option value="heading5">Heading 5</option>
			<option value="heading6">Heading 6</option>
			<option value="blockquote">Quote</option>
			<option value="paragraph">Paragraph</option>
			<option value="image">Image</option>
			<option value="accordion">Accordion (In Progress)</option>
			<option value="card">Card (In Progress)</option>
			<option value="hr">Horizontal Rule</option>
			<option value="editor">Text Editor</option>
		</select>
	</label>
</div>

<!-- <script src='https://cloud.tinymce.com/stable/tinymce.min.js?apiKey=u1z7mud98ppwucag8wv1vgvzl6uxxsth7l3qbv1go17ighu0'>
</script>
<script>
	tinymce.init({
		selector: 'textarea.tinymce',
		theme: 'modern',
		plugins: 'code print preview searchreplace autolink directionality visualchars fullscreen image link media codesample table charmap hr pagebreak nonbreaking anchor insertdatetime advlist lists textcolor wordcount imagetools contextmenu colorpicker textpattern help',
		toolbar1: 'formatselect | bold italic strikethrough forecolor backcolor | link | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent  | removeformat',
		image_advtab: true,
		content_css: [
			"https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css",
			//"/file/css/bootstrap.css",
			"/file/css/template.css"
		]
	});
</script> -->
<!-- <script src="https://formbuilder.online/assets/js/form-builder.min.js?v2.9.0"></script>
<script src="https://formbuilder.online/assets/js/form-render.min.js"></script>
<script>
	jQuery(function ($) {
		// var container = document.getElementById("build-wrap");
		var container = document.getElementsByClassName("tinymce");
		$(container).formBuilder({
			replaceFields: [{
				type: "textarea",
				subtype: "tinymce",
				label: "WYSIWYG",
			}, ],
		});
	});
</script> -->

<script>
	//variables etc.
	var count = 0;
	var $item = {};
	var ready = false;
	var Fields = {};
	Fields["staff"] = {
		Staff: true,
		Question: false,
		Card: false,
		TextEditor: false,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: "text",
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: "text",
		ColumnWidth: true,
		AddressMap: false,
	};
	Fields["heading1"] = {
		Staff: false,
		Question: true,
		Card: false,
		TextEditor: false,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: "text",
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: "text",
		ColumnWidth: true,
		AddressMap: false,
	};
	Fields["heading2"] = {
		Staff: false,
		Question: true,
		Card: false,
		TextEditor: false,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: "text",
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: "text",
		ColumnWidth: true,
		AddressMap: false,
	};
	Fields["heading3"] = {
		Staff: false,
		Question: true,
		Card: false,
		TextEditor: false,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: "text",
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: "text",
		ColumnWidth: true,
		AddressMap: false,
	};
	Fields["heading4"] = {
		Staff: false,
		Question: true,
		Card: false,
		TextEditor: false,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: "text",
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: "text",
		ColumnWidth: true,
		AddressMap: false,
	};
	Fields["heading5"] = {
		Staff: false,
		Question: true,
		Card: false,
		TextEditor: false,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: "text",
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: "text",
		ColumnWidth: true,
		AddressMap: false,
	};
	Fields["heading6"] = {
		Staff: false,
		Question: true,
		Card: false,
		TextEditor: false,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: "text",
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: "text",
		ColumnWidth: true,
		AddressMap: false,
	};
	Fields["image"] = {
		Staff: false,
		Question: true,
		Card: false,
		TextEditor: false,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: "text",
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: "text",
		ColumnWidth: true,
		AddressMap: false,
	};
	Fields["blockquote"] = {
		Staff: false,
		Question: true,
		Card: false,
		TextEditor: false,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: "text",
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: "text",
		ColumnWidth: true,
		AddressMap: false,
	};
	Fields["paragraph"] = {
		Staff: false,
		Question: true,
		Card: false,
		TextEditor: false,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: "text",
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: "text",
		ColumnWidth: true,
		AddressMap: false,
	};
	Fields["hr"] = {
		Staff: false,
		Question: false,
		Card: false,
		TextEditor: false,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: false,
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: null,
		ColumnWidth: true,
		AddressMap: false,
	};
	Fields["accordion"] = {
		Staff: false,
		Question: true,
		Card: false,
		TextEditor: false,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: "text",
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: "text",
		ColumnWidth: false,
		AddressMap: false,
	};
	Fields["card"] = {
		Staff: false,
		Question: false,
		Card: true,
		TextEditor: false,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: "text",
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: "text",
		ColumnWidth: false,
		AddressMap: false,
	};
	Fields["editor"] = {
		Staff: false,
		Question: false,
		Card: false,
		TextEditor: true,
		Help: false,
		QuestionRequired: false,
		MaxLength: false,
		LinkAttribute: false,
		DisplayCondition: false,
		TextFieldType: "textarea",
		EventCategory: false,
		QAS: false,
		CodeTable: false,
		CodeTableMulti: false,
		Country: false,
		ConditionFieldType: "text",
		ColumnWidth: false,
		AddressMap: false,
	};

	var ConditionFieldType = {};
	ConditionFieldType["text"] = {
		ddDisplayConditionValText: true,
		ddDisplayConditionIsCheckbox: false,
		ddDisplayConditionCodeTable: false,
		ddDisplayConditionEventCategory: false,
	};
	ConditionFieldType["checkbox"] = {
		ddDisplayConditionValText: false,
		ddDisplayConditionIsCheckbox: true,
		ddDisplayConditionCodeTable: false,
		ddDisplayConditionEventCategory: false,
	};
	ConditionFieldType["code table"] = {
		ddDisplayConditionValText: false,
		ddDisplayConditionIsCheckbox: false,
		ddDisplayConditionCodeTable: true,
		ddDisplayConditionEventCategory: false,
	};
	ConditionFieldType["event category"] = {
		ddDisplayConditionValText: false,
		ddDisplayConditionIsCheckbox: false,
		ddDisplayConditionCodeTable: false,
		ddDisplayConditionEventCategory: true,
	};

	$item.Row = {};
	$item.Container = {};
	$item.Table = {};
	$item.Row = $("#ItemRowTemplate").clone();
	$item.Container = $(".ItemContainer");
	$item.Table = $(".ItemTable");

	$("#ItemRowTemplate").remove();

	//loop through saved settings, and set text fields, select lists, textareas, and checkboxes (NB: not currently updating radio buttons as none have been required yet)
	$(document).ready(function () {
		$("#ddCountries").val(
			BLACKBAUD.api.customPartEditor.settings["ddCountries"]
		);
		$("#ddCountries").multiSelect();

		//load Event Categories
		$.get(
			"/WebAPI/CodeTable/b328e14b-9269-4b6c-bf93-7b10c70f71c3",
			function (data) {
				$("#ddEventCategories").empty();
				$.each(data, function () {
					$("#ddEventCategories").append(
						'<option value="' +
						this.Id +
						'">' +
						this.Description +
						"</option>"
					);
				});
				$.each(
					BLACKBAUD.api.customPartEditor.settings[
						"ddEventCategories"
					],
					function (key, value) {
						$("#ddEventCategories")
							.find('option[value="' + key + '"]')
							.prop("selected", true);
					}
				);

				$("#ddEventCategories").multiSelect();
				ready = true;
			}
		);

		$.each(BLACKBAUD.api.customPartEditor.settings, function (key, value) {
			if (key.substr(0, 3) === "chk" && value === "on") {
				$("#" + key)
					.prop("checked", true)
					.parents("table")
					.first()
					.addClass("CheckboxOptionSelected");
			} else {
				$("#" + key).val(value);
			}
		});

		var CheckReady = setInterval(function () {
			if (ready) {
				$.each(
					BLACKBAUD.api.customPartEditor.settings["items"],
					function (i) {
						addRow(
							BLACKBAUD.api.customPartEditor.settings["items"][i]
						);
					}
				);
				$('.Col3 label input[type="checkbox"]:checked')
					.closest("div")
					.addClass("open");
				ready = false;
				clearInterval(CheckReady);
			}
		}, 100);

		BuildAddressMapSelectors();
		BuildConditionalSelects();
		BuildMatrix();
	});

	Sys.Application.add_load(function () {
		$("form").validate({
			ignore: ":not(:visible)",
		});
	});

	//run this when it saves (hint: return false to cancel the save)
	BLACKBAUD.api.customPartEditor.onSave = function () {
		if ($("form").valid()) {
			var items = [];

			$(
				'#BBTabs input[type="checkbox"], #BBTabs input[type="radio"]'
			).each(function () {
				var checked = $(this).is(":checked");
				if (!checked) {
					$(this).val("off");
				} else {
					$(this).val("on");
				}
			});

			$item.Table.find(".ItemRow").each(function (i) {
				var rowdata = {
					type: $(this).attr("data-type"),
					staffName: $(this)
						.find(".Staff .staffName input")
						.val(),
					staffPosition: $(this)
						.find(".Staff .staffPosition input")
						.val(),
					staffPhone: $(this)
						.find(".Staff .staffPhone input")
						.val(),
					staffEmail: $(this)
						.find(".Staff .staffEmail input")
						.val(),
					question: $(this)
						.find(".Question input")
						.val(),
					card: $(this)
						.find(".Card input")
						.val(),
					editor: $(this)
						.find(".TextEditor textarea")
						.val(),
					help: $(this)
						.find(".Help input")
						.val(),
					columns: $(this)
						.find(".ColumnWidth select")
						.val(),
					required: $(this)
						.find(".QuestionRequired input")
						.val(),
					maxLength: $(this)
						.find(".MaxLength input")
						.val(),
					linkAttr: $(this)
						.find('.LinkAttribute input[type="checkbox"]')
						.val(),
					linkAttrLabel: $(this)
						.find('.LinkAttribute input[type="text"]')
						.val(),
					conditional: $(this)
						.find(".DisplayCondition label input")
						.val(),
					conditionalOperator: $(this)
						.find(
							".DisplayCondition select[id^=ddDisplayConditionIs]"
						)
						.val(),
					conditionalCompare: $(this)
						.find(
							".DisplayCondition select[id^=ddDisplayConditionCompare]"
						)
						.val(),
					conditionalFields: {
						textfield: $(this)
							.find(
								".DisplayCondition input[id^=ddDisplayConditionValText]"
							)
							.val(),
						checkbox: $(this)
							.find(
								".DisplayCondition input[id^=ddDisplayConditionIsCheckbox]"
							)
							.val(),
						codetable: $(this)
							.find(
								".DisplayCondition select[id^=ddDisplayConditionCodeTable]"
							)
							.val(),
						eventcategory: $(this)
							.find(
								".DisplayCondition select[id^=ddDisplayConditionEventCategory]"
							)
							.val(),
					},
					codeTableID: $(this)
						.find('.CodeTable input[type="text"]')
						.val(),
					codeTableMulti: $(this)
						.find('.CodeTableMulti input[type="checkbox"]')
						.val(),
					countryID: $(this)
						.find('.Country input[type="text"]')
						.val(),
					index: $(this)
						.find("input[id^=ItemIndex]")
						.val(),
					AddressMap: {
						Address: $(this)
							.find(".AddressMap_Address select")
							.val(),
						Suburb: $(this)
							.find(".AddressMap_Suburb select")
							.val(),
						State: $(this)
							.find(".AddressMap_State select")
							.val(),
						Postcode: $(this)
							.find(".AddressMap_Postcode select")
							.val(),
					},
				};
				items.push(rowdata);
			});

			var EventCategories = {};
			$("#ddEventCategories option:selected").each(function () {
				EventCategories[$(this).val()] = $(this).text();
			});

			BLACKBAUD.api.customPartEditor.settings["items"] = items;
			BLACKBAUD.api.customPartEditor.settings[
				"ddEventCategories"
			] = EventCategories; //$('#ddEventCategories').val();
			BLACKBAUD.api.customPartEditor.settings["ddCountries"] = $(
				"#ddCountries"
			).val();
			BLACKBAUD.api.customPartEditor.settings["txtShow"] = $(
				"#txtShow"
			).val();
			BLACKBAUD.api.customPartEditor.settings["txtLimit"] = $(
				"#txtLimit"
			).val();
			BLACKBAUD.api.customPartEditor.settings["txtAPI"] = $(
				"#txtAPI"
			).val();
			BLACKBAUD.api.customPartEditor.settings["txtButtonNext"] = $(
				"#txtButtonNext"
			).val();
			BLACKBAUD.api.customPartEditor.settings["txtButtonPrev"] = $(
				"#txtButtonPrev"
			).val();

			return true;
		} else {
			return false;
		}
	};

	//trigger on checkbox change to set the value properly... there's a bug in chrome that sets the checkbox value to 'on' even when it's been unchecked.
	$(document).on(
		"change",
		'#BBTabs input[type="checkbox"], #BBTabs input[type="radio"]',
		function () {
			var checked = $(this).is(":checked");
			if (!checked) {
				$(this).val("off");
			} else {
				$(this).val("on");
			}
		}
	);

	// Return a helper with preserved width of cells
	var fixHelper = function (e, ui) {
		ui.children().each(function (i) {
			$(this).width($(this).width());
		});
		return ui;
	};

	$item.Table.sortable({
		handle: ".ItemActionMove",
		cursor: "move",
		helper: fixHelper,
		update: function (event, ui) {
			$item.Table.find(".ItemRow").each(function (i) {
				$(this)
					.find(".Counter span")
					.text(i + 1);
			});

			// BuildAddressMapSelectors();
			BuildConditionalSelects();
			BuildMatrix();
		},
	});

	//functions
	function addRow(item) {
		console.log(item);
		var $newRow = $item.Row.clone();
		var count = GetID();

		if (item !== undefined) {
			count = item.index;
		}

		$newRow.find("div, select, input, textarea").each(function () {
			var ID = $(this).attr("id");
			var name = $(this).attr("name");

			if (ID !== undefined) {
				var newID = ID.replace("_0", "_" + count);
				$(this).attr("id", newID);
			}
			if (name !== undefined) {
				var newName = name.replace("_0", "_" + count);
				if ($(this).attr("type") != "radio") {
					$(this).attr("name", newName);
				} else {
					$(this).attr("name", "item_" + name);
				}
			}
		});

		$newRow
			.find("select[id^=ddDisplayConditionEventCategory]")
			.append($("#ddEventCategories option:selected").clone());

		if (item !== undefined) {
			$newRow.find(".Staff .staffName input").val(item.staffName);
			$newRow.find(".Staff .staffPosition input").val(item.staffPosition);
			$newRow.find(".Staff .staffPhone input").val(item.staffPhone);
			$newRow.find(".Staff .staffEmail input").val(item.staffEmail);
			$newRow.find(".Question input").val(item.question);
			$newRow.find(".Card input").val(item.question);
			$newRow.find(".TextEditor textarea").val(item.question);
			$newRow
				.find(".QuestionRequired input")
				.prop("checked", item.required == "on");
			$newRow.find(".Help input").val(item.help);
			$newRow.find(".ColumnWidth select").val(item.columns);
			$newRow
				.find('.LinkAttribute input[type="checkbox"]')
				.prop("checked", item.linkAttr == "on");
			$newRow
				.find('.LinkAttribute input[type="text"]')
				.val(item.linkAttrLabel);
			$newRow.find(".MaxLength input").val(item.maxLength);
			$newRow.find(".CodeTable input").val(item.codeTableID);
			$newRow
				.find(".CodeTableMulti input")
				.prop("checked", item.codeTableMulti == "on");
			$newRow
				.find('.DisplayCondition label input[type="checkbox"]')
				.prop("checked", item.conditional == "on");
			$newRow
				.find(".DisplayCondition select[id^=ddDisplayConditionIs]")
				.val(item.conditionalOperator);
			$newRow
				.find(".DisplayCondition select[id^=ddDisplayConditionCompare]")
				.attr("data-value", item.conditionalCompare);
			$newRow
				.find(".DisplayCondition input[id^=ddDisplayConditionValText]")
				.val(item.conditionalFields.textfield);
			$newRow
				.find(
					".DisplayCondition input[id^=ddDisplayConditionIsCheckbox]"
				)
				.prop("checked", item.conditional == "on");
			$newRow
				.find(
					".DisplayCondition select[id^=ddDisplayConditionCodeTable]"
				)
				.attr("data-value", item.conditionalFields.codetable);
			$newRow
				.find(
					".DisplayCondition input[id^=ddDisplayConditionEventCategory]"
				)
				.val(item.conditionalFields.eventcategory);
			if (item.AddressMap) {
				$newRow
					.find(".AddressMap_Address select")
					.attr("data-value", item.AddressMap.Address);
				$newRow
					.find(".AddressMap_Suburb select")
					.attr("data-value", item.AddressMap.Suburb);
				$newRow
					.find(".AddressMap_State select")
					.attr("data-value", item.AddressMap.State);
				$newRow
					.find(".AddressMap_Postcode select")
					.attr("data-value", item.AddressMap.Postcode);
			}
			$newRow.find(".Country input").val(item.countryID);

			$newRow.attr("data-type", item.type);
			$newRow.find(".FieldType").text(item.type);
			$newRow.find("input[id^=ItemIndex]").val(item.index);
		} else {
			$newRow.find("input[id^=ItemIndex]").val(count);
			$newRow.attr("data-type", $("#NewItemFieldType").val());
			$newRow.find(".FieldType").text($("#NewItemFieldType").val());
		}

		$newRow
			.find(".LinkAttributeExpand, .DisplayconditionExpand")
			.slideUp(0);
		if (
			$newRow.find('.LinkAttribute input[type="checkbox"]').is(":checked")
		) {
			$newRow.find(".LinkAttributeExpand").slideDown(150);
		}
		if (
			$newRow
			.find('.DisplayCondition input[type="checkbox"]')
			.is(":checked")
		) {
			$newRow.find(".DisplayconditionExpand").slideDown(150);
		}

		$.each(Fields[$newRow.attr("data-type")], function (key, value) {
			if (!value) {
				$newRow.find("." + key).remove();
			}
		});

		$item.Table.append($newRow);

		$item.Table.find(".ItemRow").each(function (i) {
			$(this)
				.find(".Counter span")
				.text(i + 1);
		});

		// BuildAddressMapSelectors();
		BuildConditionalSelects();
		BuildMatrix();
		$newRow
			.find(".DisplayCondition select[id^=ddDisplayConditionCompare]")
			.change();
		$newRow.find(".CodeTableMulti input").change();
		$newItem.dialog("close");
	}

	function BuildConditionalSelects() {
		$(".ItemRow")
			.find(".DisplayCondition select[id^=ddDisplayConditionCompare]")
			.empty()
			.append($("<option>&lt;Select a question&gt;</option>"));

		$(".ItemRow")
			.not('[data-type="page break"]')
			.each(function (i) {
				if (
					$(this).attr("data-type") == "code table" &&
					$(this)
					.find(".CodeTableMulti input")
					.is(":checked")
				) {
					return;
				}

				var ID = $(this)
					.find("input[id^=ItemIndex]")
					.val();
				var Question = $(this)
					.find(".Question input")
					.val();

				var counter = $(this)
					.find(".Counter")
					.text()
					.trim();

				$(".ItemRow")
					.find(
						".DisplayCondition select[id^=ddDisplayConditionCompare]"
					)
					.each(function () {
						$(this).append(
							$("<option></option>")
							.text(counter + ". " + Question)
							.val(ID)
						);
						$(this)
							.filter("[data-value]")
							.val($(this).attr("data-value"));
					});
			});
	}

	$(document).on(
		"change",
		".DisplayCondition select[id^=ddDisplayConditionCompare], .DisplayCondition select[id^=ddDisplayConditionCodeTable]",
		function () {
			$(this).attr("data-value", $(this).val());
		}
	);

	//action links
	$(document).on("click", ".ItemActionAdd", function (e) {
		e.preventDefault();
		$newItem.dialog("open");
	});

	$(document).on("click", ".ItemActionDelete", function (e) {
		e.preventDefault();
		if (confirm("This will remove this question.  Are you sure?")) {
			$(this)
				.parents(".ItemRow")
				.remove();
			$(".ItemRow").each(function (i) {
				$(this)
					.find(".Counter span")
					.text(i + 1);
			});
		}

		// BuildAddressMapSelectors();
		BuildConditionalSelects();
		BuildMatrix();
	});

	//make a string safe for a css class (for filtering categories)
	function makeSafeForCSS(name) {
		return name.replace(/[^a-z0-9]/g, function (s) {
			var c = s.charCodeAt(0);
			if (c == 32) return "-";
			if (c >= 65 && c <= 90) return "_" + s.toLowerCase();
			return "__" + ("000" + c.toString(16)).slice(-4);
		});
	}

	$("#BBTabs").tabs();

	function GetID() {
		var maximum = 0;
		$(".ItemRow").each(function () {
			var value = parseFloat(
				$(this)
				.find("input[id^=ItemIndex]")
				.val()
			);
			maximum = value > maximum ? value : maximum;
		});
		return maximum + 1;
	}

	$newItem = $("#newItem").dialog({
		autoOpen: false,
		height: 200,
		width: 320,
		modal: true,
		buttons: {
			Add: function () {
				addRow();
			},
			Cancel: function () {
				$newItem.dialog("close");
			},
		},
	});

	$(document).on(
		"click",
		'.LinkAttribute label input[type="checkbox"], .DisplayCondition label input[type="checkbox"]',
		function () {
			$(this)
				.parent()
				.next()
				.slideToggle(150);
		}
	);
	$(document).on("change", ".top input", BuildConditionalSelects);
	$(document).on("change", ".top input", BuildAddressMapSelectors);
	$(document).on("change", ".top input", BuildMatrix);

	$(document).on("click", '.Col3 label input[type="checkbox"]', function () {
		if ($(this).is(":checked")) {
			$(this)
				.closest("div")
				.addClass("open");
		} else {
			$(this)
				.closest("div")
				.removeClass("open");
		}
	});
	$(document).on("change", ".CodeTableMulti input", function () {
		if ($(this).is(":checked")) {
			$(this)
				.parents(".ItemRow")
				.find(".LinkAttribute input, .QuestionRequired input")
				.prop("checked", false)
				.trigger("change")
				.parents(".LinkAttribute, .QuestionRequired")
				.removeClass("open")
				.hide();
		} else {
			$(this)
				.parents(".ItemRow")
				.find(".LinkAttribute input, .QuestionRequired input")
				.parents(".LinkAttribute, .QuestionRequired")
				.show();
		}
	});
	$(document).on("click", ".header-cell a.all", function () {
		var ix = $(this)
			.parent()
			.index();
		$(".flexgrid section .body-row").each(function () {
			$(this)
				.children()
				.eq(ix)
				.find("input")
				.prop("checked", true);
		});
	});
	$(document).on("click", ".header-cell a.none", function () {
		var ix = $(this)
			.parent()
			.index();
		$(".flexgrid section .body-row").each(function () {
			$(this)
				.children()
				.eq(ix)
				.find("input")
				.prop("checked", false);
		});
	});
	$(document).on("change", '.flexgrid input[type="checkbox"]', function () {
		BLACKBAUD.api.customPartEditor.settings["Matrix"] = GetMatrixResults();
	});

	function GetMatrixResults() {
		var MatrixResults = {};
		$(".flexgrid .header-cell[data-value]").each(function () {
			var eventID = $(this).attr("data-value");
			MatrixResults[eventID] = {};
			$(".flexgrid .body-row").each(function () {
				var V = $(this)
					.find('input[data-id="' + eventID + '"]')
					.is(":checked");
				var Q = $(this).attr("data-index");
				MatrixResults[eventID][Q] = V;
			});
		});
		return MatrixResults;
	}

	function BuildMatrix() {
		var $SelectedEvents = $("#ddEventCategories option:selected");
		var $Questions = $(".ItemRow").not('[data-type="page break"]');
		var $header = $(".flexgrid header");
		var $body = $(".flexgrid section");
		BLACKBAUD.api.customPartEditor.settings.Matrix =
			BLACKBAUD.api.customPartEditor.settings.Matrix || {};

		$body.empty();
		$header.empty().append('<div class="spacer"></div>');

		$SelectedEvents.each(function () {
			$header.append(
				$('<div class="header-cell"></div>')
				.text($(this).text())
				.attr("data-value", $(this).val())
				.append(
					"<br /><a class='all' href='#' style='text-decoration: none;'>(all)</a> <a class='none' href='#' style='text-decoration: none;'>(none)</a>"
				)
			);
		});
		$Questions.each(function (i) {
			var QuestionID = $(this)
				.find("[id^=ItemIndex]")
				.val();
			var DataType = $(this).attr("data-type");
			var $row = $('<div class="body-row"></div>').attr(
				"data-index",
				QuestionID
			);
			$row.append(
				$('<div class="body-header-cell"></div>')
				.text(
					i +
					1 +
					". " +
					$(this)
					.find(".Question input")
					.val()
				)
				.append(" <span>[" + DataType + "]</span>")
			);
			$SelectedEvents.each(function () {
				var EventID = $(this).val();
				var Disabled = false;
				var IsChecked = false;
				if (
					typeof BLACKBAUD.api.customPartEditor.settings.Matrix[
						EventID
					] !== "undefined"
				) {
					if (
						typeof BLACKBAUD.api.customPartEditor.settings.Matrix[
							EventID
						][QuestionID] !== "undefined"
					) {
						IsChecked =
							BLACKBAUD.api.customPartEditor.settings.Matrix[
								EventID
							][QuestionID];
					}
				}
				if (DataType == "event category") {
					IsChecked = true;
					Disabled = true;
				}
				$row.append(
					$('<div class="body-cell"></div>').append(
						$('<input type="checkbox" />')
						.prop("checked", IsChecked)
						.prop("disabled", Disabled)
						.attr("data-id", EventID)
					)
				);
			});
			$body.append($row);
		});
	}

	function BuildAddressMapSelectors() {
		$(".AddressMap div[data-map]").each(function () {
			var map = $(this).attr("data-map");
			var select = $(this).find("select");
			select.empty();
			select.append($('<option value="unmapped">Unmapped</option>'));
			$('.ItemRow[data-type="' + map + '"]').each(function () {
				var text = $(this)
					.find(".Question input")
					.val();
				var ID = $(this)
					.find("input[id^=ItemIndex]")
					.val();
				var counter = $(this)
					.find(".Counter")
					.text()
					.trim();
				select.append(
					$(
						'<option value="' +
						ID +
						'">' +
						counter +
						". " +
						text +
						"</option>"
					)
				);
			});

			select.val(select.attr("data-value"));
		});
	}

	$(document).on("change", ".AddressMap div[data-map] select", function () {
		$(this).attr("data-value", $(this).val());
	});
</script>